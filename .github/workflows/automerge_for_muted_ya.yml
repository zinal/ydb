# Adds automerge label to open mute-unmute PRs targeting main. Runs at 08:00 UTC daily.
name: Automerge for muted_ya (main)

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

jobs:
  set-automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Add automerge label to main-branch mute-unmute PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.YDBOT_TOKEN }}
          script: |
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'mute-unmute',
              per_page: 100
            });
            const prs = issues.filter(i => i.pull_request);
            core.info(`mute-unmute PRs: ${prs.length}`);
            let added = 0;
            for (const issue of prs) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issue.number
              });
              if (pr.base.ref !== 'main') continue;
              if (pr.labels?.some(l => l.name === 'automerge')) continue;
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['automerge']
              });
              core.info(`#${issue.number} (main): added automerge`);
              added++;
            }
            core.info(`done; added automerge to ${added} PR(s)`);
